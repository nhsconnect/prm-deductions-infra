#!/bin/bash -e

## Install OpenVPN

yum -y update
yum install -y https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
yum -y install openvpn

aws s3 cp s3://${OPENTEST_ASSETS_BUCKET}/vpn-client-1318-10.0.225.80.tar vpn-client-1318-10.0.225.80.tar

tar xvf vpn-client-1318-10.0.225.80.tar -C /etc/openvpn

systemctl enable openvpn@vpn-client-1318-10.0.225.80.linux
systemctl start openvpn@vpn-client-1318-10.0.225.80.linux

## Enable IP forwarding so any packet delivered to the gateway will be forwarded

cat <<EOF > /etc/sysctl.d/10-enable-ip-forward.conf
net.ipv4.ip_forward=1
EOF

echo "1" > /proc/sys/net/ipv4/ip_forward

## Enable Source NAT (via MASQUERADE) so packets from the VPN are routed back to the gateway

mkdir /etc/iptables

cat <<EOF > /etc/iptables/iptables.rules
# Generated by iptables-save v1.4.21 on Fri Feb  1 16:25:48 2019
*nat
:PREROUTING ACCEPT [8:424]
:INPUT ACCEPT [1:60]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
-A POSTROUTING -o tap0 -j MASQUERADE
COMMIT
EOF

cat <<EOF > /usr/lib/systemd/system/iptables.service
[Unit]
Description=Packet Filtering Framework

[Service]
Type=oneshot
ExecStart=/usr/sbin/iptables-restore /etc/iptables/iptables.rules
ExecReload=/usr/sbin/iptables-restore /etc/iptables/iptables.rules
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
EOF

systemctl enable iptables
systemctl start iptables
